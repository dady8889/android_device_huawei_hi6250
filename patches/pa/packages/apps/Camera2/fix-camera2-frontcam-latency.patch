From c8151b5db51926e4cb996beecd1628a78a450b87 Mon Sep 17 00:00:00 2001
From: Daniel <dady8889@gmail.com>
Date: Fri, 3 Feb 2017 20:25:37 +0100
Subject: [PATCH] Fix front camera snap latency

Change-Id: Ieba195b31e4708a1d49ec0c56fd0b459d4e4a4d3
---
 src/com/android/camera/app/CameraApp.java                    |  2 ++
 .../android/camera/one/v2/OneCameraCharacteristicsImpl.java  | 12 ++++++++++++
 .../android/camera/one/v2/autofocus/TriggerStateMachine.java | 11 ++++++++++-
 3 files changed, 24 insertions(+), 1 deletion(-)

diff --git a/src/com/android/camera/app/CameraApp.java b/src/com/android/camera/app/CameraApp.java
index a6f0d52..b3fca61 100644
--- a/src/com/android/camera/app/CameraApp.java
+++ b/src/com/android/camera/app/CameraApp.java
@@ -20,6 +20,7 @@ import android.app.Application;
 import android.app.NotificationManager;
 import android.content.Context;
 import android.os.Debug;
+import android.os.Bundle;
 
 import com.android.camera.stats.UsageStatistics;
 import com.android.camera.stats.profiler.Profile;
@@ -41,6 +42,7 @@ public class CameraApp extends Application {
      * up and it would be too late to attach a debugger afterwards.
      */
     private static final boolean WAIT_FOR_DEBUGGER_ON_START = false;
+    public static Bundle settingsBundle = new Bundle();
 
     @Override
     public void onCreate() {
diff --git a/src/com/android/camera/one/v2/OneCameraCharacteristicsImpl.java b/src/com/android/camera/one/v2/OneCameraCharacteristicsImpl.java
index 279ede3..4457b9a 100644
--- a/src/com/android/camera/one/v2/OneCameraCharacteristicsImpl.java
+++ b/src/com/android/camera/one/v2/OneCameraCharacteristicsImpl.java
@@ -233,6 +233,12 @@ public class OneCameraCharacteristicsImpl implements OneCameraCharacteristics {
     public boolean isAutoFocusSupported() {
         Integer maxAfRegions = mCameraCharacteristics.get(
               CameraCharacteristics.CONTROL_MAX_REGIONS_AF);
+
+        OneCamera.Facing cameraFacing = getCameraDirection();
+        if (cameraFacing != null && cameraFacing == OneCamera.Facing.FRONT) {
+            return false;
+        }
+        
         // Auto-Focus is supported if the device supports one or more AF regions
         return maxAfRegions != null && maxAfRegions > 0;
     }
@@ -241,6 +247,12 @@ public class OneCameraCharacteristicsImpl implements OneCameraCharacteristics {
     public boolean isAutoExposureSupported() {
         Integer maxAeRegions = mCameraCharacteristics.get(
               CameraCharacteristics.CONTROL_MAX_REGIONS_AE);
+
+        OneCamera.Facing cameraFacing = getCameraDirection();
+        if (cameraFacing != null && cameraFacing == OneCamera.Facing.FRONT) {
+            return false;
+        }
+        
         // Auto-Exposure is supported if the device supports one or more AE regions
         return maxAeRegions != null && maxAeRegions > 0;
     }
diff --git a/src/com/android/camera/one/v2/autofocus/TriggerStateMachine.java b/src/com/android/camera/one/v2/autofocus/TriggerStateMachine.java
index 95d2523..168e90d 100644
--- a/src/com/android/camera/one/v2/autofocus/TriggerStateMachine.java
+++ b/src/com/android/camera/one/v2/autofocus/TriggerStateMachine.java
@@ -26,6 +26,9 @@ import java.util.Set;
 import javax.annotation.ParametersAreNonnullByDefault;
 import javax.annotation.concurrent.NotThreadSafe;
 
+import com.android.camera.app.CameraApp;
+import android.os.Bundle;
+
 /**
  * Tracks the finite state machines used by the camera2 api for AF and AE
  * triggers. That is, the state machine waits for a TRIGGER_START followed by
@@ -76,6 +79,12 @@ final class TriggerStateMachine {
         boolean triggeredNow = triggerState != null && triggerState == mTriggerStart;
         boolean doneNow = mDoneStates.contains(state);
 
+        String str = CameraApp.settingsBundle.getString("facing");
+        if (str != null && str == "front") {
+                return true;
+        }
+
+        
         if (mCurrentState == State.WAITING_FOR_TRIGGER) {
             if (mLastTriggerFrameNumber == null || frameNumber > mLastTriggerFrameNumber) {
                 if (triggeredNow) {
-- 
1.9.1

